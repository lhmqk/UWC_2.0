<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UWC - Homepage</title>
    <link rel="stylesheet" href="./css/index.css" />
    <link rel="stylesheet" href="./css/chat.css" />
    <link rel="stylesheet" href="./css/route.css" />
    <link rel="stylesheet" href="./css/home.css" />
    <link rel="stylesheet" href="./css/view.css" />
    <link rel="stylesheet" href="./css/login.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/@goongmaps/goong-js@1.0.9/dist/goong-js.js'></script>
    <link href='https://cdn.jsdelivr.net/npm/@goongmaps/goong-js@1.0.9/dist/goong-js.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/@goongmaps/goong-geocoder/dist/goong-geocoder.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/@goongmaps/goong-geocoder/dist/goong-geocoder.css"
      rel="stylesheet"
      type="text/css"
    />
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <span class="logo">S</span>
        <a class="logo-expand" href="#">UWC 2.0</a>
        <div class="side-wrapper">
          <div class="side-title">MENU</div>
          <div class="side-menu">
            <a class="sidebar-link home is-active" href="#">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5ZM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5Z"
                />
              </svg>
              Trang chủ
            </a>
            <a class="sidebar-link view" href="#">
              <svg fill="currentColor" viewBox="0 0 16 16">
                <path
                  d="M3 4.5h10a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1H3zM1 2a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 2zm0 12a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 14z"
                />
              </svg>
              Hiển thị
            </a>
            <a class="sidebar-link assign" href="#">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 3H2v1h1V3z"
                />
                <path
                  d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9z"
                />
                <path
                  fill-rule="evenodd"
                  d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5V7zM2 7h1v1H2V7zm0 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5H2zm1 .5H2v1h1v-1z"
                />
              </svg>
              Phân công
            </a>
            <a class="sidebar-link route" href="#" onclick="calcRoute()">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M3.1 11.2a.5.5 0 0 1 .4-.2H6a.5.5 0 0 1 0 1H3.75L1.5 15h13l-2.25-3H10a.5.5 0 0 1 0-1h2.5a.5.5 0 0 1 .4.2l3 4a.5.5 0 0 1-.4.8H.5a.5.5 0 0 1-.4-.8l3-4z"
                />
                <path
                  fill-rule="evenodd"
                  d="M8 1a3 3 0 1 0 0 6 3 3 0 0 0 0-6zM4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999z"
                />
              </svg>
              Tuyến đường
            </a>
            <a class="sidebar-link message" href="#">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"
                />
                <path
                  d="M5 6a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"
                />
              </svg>
              Tin nhắn
            </a>
          </div>
        </div>
        <div class="side-wrapper"></div>
      </div>
      <div class="wrapper">
        <div class="header">
          <div class="search-bar">
            <input type="text" placeholder="Tìm kiếm" />
          </div>
          <div class="user-settings">
            <img
              class="user-img"
              src="https://www.gravatar.com/avatar/b3568450826559f6ce26b424b8283279.jpg?size=240&d=https%3A%2F%2Fwww.artstation.com%2Fassets%2Fdefault_avatar.jpg"
              alt=""
              id="profilePicture"
            />
            <div class="user-name" id="fullname">User</div>
            <svg viewBox="0 0 492 492" fill="currentColor">
              <path
                d="M484.13 124.99l-16.11-16.23a26.72 26.72 0 00-19.04-7.86c-7.2 0-13.96 2.79-19.03 7.86L246.1 292.6 62.06 108.55c-5.07-5.06-11.82-7.85-19.03-7.85s-13.97 2.79-19.04 7.85L7.87 124.68a26.94 26.94 0 000 38.06l219.14 219.93c5.06 5.06 11.81 8.63 19.08 8.63h.09c7.2 0 13.96-3.57 19.02-8.63l218.93-219.33A27.18 27.18 0 00492 144.1c0-7.2-2.8-14.06-7.87-19.12z"
              ></path>
            </svg>
            <div class="notify">
              <div class="notification"></div>
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M18.707 8.796c0 1.256.332 1.997 1.063 2.85.553.628.73 1.435.73 2.31 0 .874-.287 1.704-.863 2.378a4.537 4.537 0 01-2.9 1.413c-1.571.134-3.143.247-4.736.247-1.595 0-3.166-.068-4.737-.247a4.532 4.532 0 01-2.9-1.413 3.616 3.616 0 01-.864-2.378c0-.875.178-1.682.73-2.31.754-.854 1.064-1.594 1.064-2.85V8.37c0-1.682.42-2.781 1.283-3.858C7.861 2.942 9.919 2 11.956 2h.09c2.08 0 4.204.987 5.466 2.625.82 1.054 1.195 2.108 1.195 3.745v.426zM9.074 20.061c0-.504.462-.734.89-.833.5-.106 3.545-.106 4.045 0 .428.099.89.33.89.833-.025.48-.306.904-.695 1.174a3.635 3.635 0 01-1.713.731 3.795 3.795 0 01-1.008 0 3.618 3.618 0 01-1.714-.732c-.39-.269-.67-.694-.695-1.173z"
                />
              </svg>
            </div>
          </div>
        </div>
        <div class="main-container">
          <div class="loginWrapper">
            <div class="loginBox">
              <div class="login-box">
                <h2>Chào mừng quay trở lại</h2>
                <form>
                  <div class="user-box">
                    <input type="text" name="" required="" />
                    <label>Tên đăng nhập</label>
                  </div>
                  <div class="user-box">
                    <input type="password" name="" required="" />
                    <label>Mật khẩu</label>
                  </div>
                  <a class="googleLoginBtn" href="https://accounts.google.com/o/oauth2/v2/auth?client_id=126370380117-jot44828cqfii06v3narofen8s2q5h51.apps.googleusercontent.com&prompt=select_account&redirect_uri=https%3A%2F%2Fuwc.ddns.net%2Flogin%2Fcallback&response_type=code&scope=email profile">Đăng nhập bằng Google</a>
                  <a class="loginBtn"> Đăng nhập </a>
                </form>
              </div>
            </div>
          </div>
          <script>
            {
              const params = new URLSearchParams(window.location.search);
              const name = params.get("name");
              const picture = params.get("picture");
              if (name && picture) {
                document.getElementById("fullname").innerText = name;
                document.getElementById("profilePicture").src = picture;
                document.querySelector(".loginWrapper").className = "loginWrapper";
              }
              else document.querySelector(".loginWrapper").className = "loginWrapper show";
            }
          </script>
          <div class="home-section section show anim">
            <div id="homeWrapper">
              <img src="./img/logo/4234142.png" />
              <footer>
                <div class="footerCol">
                  <h6>Giới thiệu:</h6>
                  <ul>
                    <li>Đội ngũ phát triển từ ĐHBK-TPHCM</li>
                    <li>Lớp CC05-Công nghệ phần mềm</li>
                  </ul>
                </div>

                <div class="footerCol">
                  <h6>Về hệ thống:</h6>
                  <ul>
                    <li>Phiên bản 2.0</li>
                    <li>Nâng cấp và tái sử dụng dữ liệu từ bản 1.0</li>
                  </ul>
                </div>

                <div class="footerCol">
                  <h6>Liên lạc:</h6>
                  <ul>
                    <li>Email: artists@hcmut.edu.vn</li>
                    <li>SĐT: 0254.3456.789</li>
                  </ul>
                </div>
              </footer>
            </div>
          </div>
          <div class="view-section section anim">
            <div class="viewWrapperEmp show">
              <div class="empBox">
                <div class="empBoxImg">
                  <img src="./img/logo/picasso.png" />
                </div>
                <div class="empBoxInfo">
                  <p class="empBoxInfoName">Tên: QuangLo</p>
                  <p class="empBoxInfoId">MSNV: 2052113</p>
                  <p class="empBoxInfoRole">Chức vụ: Lái xe</p>
                </div>
              </div>
              <div class="empBox" id="janitor0">
                <div class="empBoxImg">
                  <img
                    src="https://cdn.britannica.com/18/136518-050-CD0E49C6/The-Beatles-Ringo-Starr-Paul-McCartney-George.jpg"
                  />
                </div>
                <div class="empBoxInfo">
                  <p class="empBoxInfoName">Tên: LongTon</p>
                  <p class="empBoxInfoId">MSNV: 2052114</p>
                  <p class="empBoxInfoRole">Chức vụ: Lao công</p>
                </div>
              </div>
              <div class="empBox" id="janitor1">
                <div class="empBoxImg">
                  <img
                    src="https://i.discogs.com/UooWvTWsiyzFDhmuT0SUkpxLZBGcsyMcatV8uiGj04g/rs:fit/g:sm/q:90/h:450/w:600/czM6Ly9kaXNjb2dz/LWRhdGFiYXNlLWlt/YWdlcy9BLTU5Nzky/LTE0MDAwNjE4NjIt/OTY5Mi5qcGVn.jpeg"
                  />
                </div>
                <div class="empBoxInfo">
                  <p class="empBoxInfoName">Tên: KhoaT</p>
                  <p class="empBoxInfoId">MSNV: 2052115</p>
                  <p class="empBoxInfoRole">Chức vụ: Lao công</p>
                </div>
              </div>
              <div class="empBox" id="janitor2">
                <div class="empBoxImg">
                  <img
                    src="https://kenh14cdn.com/thumb_w/660/203336854389633024/2022/6/16/photo-2-1655348630903722809076.jpg"
                  />
                </div>
                <div class="empBoxInfo">
                  <p class="empBoxInfoName">Tên: CuCai</p>
                  <p class="empBoxInfoId">MSNV: 2052007</p>
                  <p class="empBoxInfoRole">Chức vụ: Lao công</p>
                </div>
              </div>
              <div class="empBox">
                <div class="empBoxImg">
                  <img
                    src="https://cdn.britannica.com/41/197341-050-4859B808/The-Rolling-Stones-Bill-Wyman-Keith-Richards-1964.jpg"
                  />
                </div>
                <div class="empBoxInfo">
                  <p class="empBoxInfoName">Tên: MinhLe</p>
                  <p class="empBoxInfoId">MSNV: 205200c</p>
                  <p class="empBoxInfoRole">Chức vụ: Lao công</p>
                </div>
              </div>
              <div class="empBox">
                <div class="empBoxImg">
                  <img
                    src="https://www.billboard.com/wp-content/uploads/media/10-chuck-berry-portrait-billboard-1240.jpg"
                  />
                </div>
                <div class="empBoxInfo">
                  <p class="empBoxInfoName">Tên: aTan</p>
                  <p class="empBoxInfoId">MSNV: 2052sos</p>
                  <p class="empBoxInfoRole">Chức vụ: Lao công</p>
                </div>
              </div>
              <div class="empBox">
                <div class="empBoxImg">
                  <img
                    src="https://123oclock4oclockrock.files.wordpress.com/2019/01/jimihendrix-portrait.jpg"
                  />
                </div>
                <div class="empBoxInfo">
                  <p class="empBoxInfoName">Tên: TruongB</p>
                  <p class="empBoxInfoId">MSNV: 2052111</p>
                  <p class="empBoxInfoRole">Chức vụ: Lái cực mạnh</p>
                </div>
              </div>
              <div class="empBox">
                <div class="empBoxImg">
                  <img
                    src="https://www.biography.com/.image/t_share/MTgwNTA2Nzk2MjgzMTQzMjU2/gettyimages-476549927.jpg"
                  />
                </div>
                <div class="empBoxInfo">
                  <p class="empBoxInfoName">Tên: 4Hai</p>
                  <p class="empBoxInfoId">MSNV: 2052444</p>
                  <p class="empBoxInfoRole">Chức vụ: Lái dữ</p>
                </div>
              </div>
              <div class="empBox">
                <div class="empBoxImg">
                  <img
                    src="https://www.biography.com/.image/t_share/MTcyNDMwMjQzNjk1NDM2ODgz/little-richard-profile.jpg"
                  />
                </div>
                <div class="empBoxInfo">
                  <p class="empBoxInfoName">Tên: TungV</p>
                  <p class="empBoxInfoId">MSNV: 2052ddd</p>
                  <p class="empBoxInfoRole">Chức vụ: Lao công</p>
                </div>
              </div>
            </div>
            <div class="viewWrapperTask">
              <h2>Công việc</h2>
              <div class="viewPlit">
                <div>
                  <form id="event-form" action="#">
                    <h3>Thêm công việc</h3>
                    <ul>
                      <li>
                        <label for="event-start">
                          <i aria-hidden="true"></i>Từ</label
                        >
                        <input
                          id="new-taskFrom"
                          type="datetime-local"
                          name="start"
                        />
                      </li>
                      <li>
                        <label for="event-end"
                          ><i aria-hidden="true"></i>Đến</label
                        >
                        <input
                          id="new-taskTo"
                          type="datetime-local"
                          name="end"
                        />
                      </li>
                      <li>
                        <label for="event-title"
                          ><i aria-hidden="true"></i>Công việc</label
                        >
                        <input id="new-taskName" type="text" name="title" />
                      </li>
                      <li style="display: none;">
                        <label for="event-employee"
                          ><i aria-hidden="true"></i>Nhân viên</label
                        >
                        <input id="new-taskEmp" type="text" name="employee" />
                      </li>
                      <li>
                        <label for="event-details"
                          ><i aria-hidden="true"></i>Mô tả</label
                        >
                        <textarea
                          id="new-taskDesc"
                          name="details"
                          rows="4"
                        ></textarea>
                      </li>
                      <li>
                        <style>
                          .mapboxgl-ctrl-geocoder--input {
                            background: #353340;
                            background-color: #353340;
                            border: none;
                            width: 100rem;
                          }
                          .suggestions-wrapper,
                          .mapboxgl-ctrl-geocoder--pin-right
                          {
                            background: #353340;
                            border: none;
                            border-radius: 0px;
                            display: none;
                          }
                          
                        </style>
                        <div id="diachisearch" style="width: 100%;"></div>
                        <input hidden id="diachi">
                      </li>
                      <script>
                        const geocoder = new GoongGeocoder({
                            accessToken: 'kUaBX9nRKvgbg8oJa325vHuvd9aArxoJmRBiHIlM'
                        });
                        geocoder.addTo('#diachisearch');
                        const loc = document.getElementById('diachi');
                        geocoder.on('result', ({result}) => {
                            const {lat, lng} = result.result.geometry.location;
                            const address = result.result.formatted_address;
                            loc.value = `${lat},${lng};${address}`;
                            
                        });
                        geocoder.on('clear', () => location.value = '');
                      </script>
                      <div class="button">
                        <button id="addTaskBtn">Thêm</button>
                      </div>
                    </ul>
                  </form>
                </div>
                <div>
                  <h3>Cần làm</h3>
                  <ul id="incomplete-tasks">
                  </ul>

                  <h3>Hoàn thành</h3>
                  <ul id="completed-tasks">
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div class="assign-section section anim">Phân công</div>

          <div class="route-section section anim">
                        
            
            <div id='map' style="width: 100%; height: 100%;"></div>
            <script>
              
            
            goongjs.accessToken = 'nzLK6wcJFBQKxqI3rqeon8LofhHhOfzs3uLNcZ39';

            function calcRoute() {
              document.getElementById("map").innerHTML = '';
            
              var map = new goongjs.Map({
                  container: 'map',
                  style: 'https://tiles.goong.io/assets/goong_map_web.json',
                  center: [106.658573, 10.7590557],
                  zoom: 15
              });
              let dstMarker = new goongjs.Marker({ color: '#0000FF' });
              let srcMarker = new goongjs.Marker({ color: '#FF0000' });


              map.on('load', async function () {
                
                  map.resize();
                  const result = await (await fetch("/api/optimalRoute")).json();
                  const [minCost, _, inorderCost] = result.slice(0, 3);
                  const paths = result.slice(3).map(v => {
                    const r = v.split(',');
                    return [parseFloat(r[1]), parseFloat(r[0])];
                  });
                  
                  dstMarker.setLngLat(paths[1]).addTo(map);
                  srcMarker.setLngLat(paths[0]).addTo(map);
                  map.addSource('route', {
                      'type': 'geojson',
                      'data': {
                          'type': 'Feature',
                          'properties': {},
                          'geometry': {
                              'type': 'LineString',
                              'coordinates': paths
                          }
                      }
                  });
                  map.addLayer({
                      'id': 'route',
                      'type': 'line',
                      'source': 'route',
                      'layout': {
                          'line-join': 'round',
                          'line-cap': 'round'
                      },
                      'paint': {
                          'line-color': '#888',
                          'line-width': 8
                      }
                  });
                  await new Promise(resolve => setTimeout(resolve));
                  
                  alert(`You saved ${(1 - minCost / inorderCost) * 100}%`);
              });
            }
            </script>
          </div>

          <div class="message-section section anim">
            <div class="app">
              <div class="screen join-screen active">
                <div class="form">
                  <img src="./img/logo/4234142.png" alt="" />
                  <h2 class="langchange" data-key="chatroom">
                    Tham gia phòng chat UWC
                  </h2>
                  <div class="form-input">
                    <label class="langchange" data-key="name"
                      >Hãy nhập biệt danh của bạn:</label
                    >
                    <input
                      type="text"
                      name="username"
                      id="username"
                      placeholder="Biệt danh của bạn"
                    />
                  </div>
                  <div class="form-input">
                    <button id="join-user" class="langchange" data-key="join">
                      Tham gia
                    </button>
                  </div>
                </div>
              </div>
              <div class="screen chat-screen">
                <div class="header">
                  <div class="logo langchange" data-key="innerchat">
                    Phòng chat UWC
                  </div>
                  <button id="exit-chat">
                    <p>Thoát</p>
                  </button>
                </div>
                <div class="messages">
                  <img src="./img/logo/4234142.png" alt="" />
                </div>
                <div class="typebox">
                  <input type="text" id="message-input" />
                  <button id="send-message" class="langchange" data-key="send">
                    Gửi
                  </button>
                </div>
              </div>
            </div>

            <script
              type="text/javascript"
              src="socket.io/socket.io.js"
            ></script>
            <script type="text/javascript" src="code.js"></script>
            <script>
              var joininput = document.getElementById("username");
              joininput.addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                  event.preventDefault();
                  document.getElementById("join-user").click();
                }
              });

              var sendinput = document.getElementById("message-input");
              sendinput.addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                  event.preventDefault();
                  document.getElementById("send-message").click();
                }
              });
              let janitorEmail = null;
              let backofficerEmail = "binh.nguyen288@hcmut.edu.vn";
              async function setJanitorEmail(email) {
                janitorEmail = email;
                console.log(email);
                const response = await fetch("/api/getTasks");
                const arr = await response.json();
                document.getElementById("incomplete-tasks").innerHTML = '';
                document.getElementById("completed-tasks").innerHTML = '';

                arr.filter(v => v.workerEmail === email)
                .forEach(({taskid, jobname, start, end, description, status}) => {
                  const newElement = createNewTaskElement(jobname, start, end, janitorEmail, description);
                  if (status === "completed") {
                    completedTasksHolder.appendChild(newElement);
                  }
                  else {
                    incompleteTasksHolder.appendChild(newElement);
                    bindTaskEvents(newElement, function() {
                      taskCompleted.call(this);
                      fetch(`/api/completeTask?taskid=${taskid}`, { method: "GET" });
                    });
                  }
                })
              }

              async function loadAssignTask() {
                const response = await fetch("/api/getUsersInfo");
                const arr = await response.json();
                arr.filter(v => v.role === "janitor")
                .forEach((v, i) => {
                  const doc = document.getElementById(`janitor${i}`);
                  doc.innerHTML = `<div class="empBoxImg">
                    <img
                      src="${v.picture}"
                    />
                  </div>
                  <div class="empBoxInfo">
                    <p class="empBoxInfoName">Tên: ${v.fullname}</p>
                    <p class="empBoxInfoId">MSNV: ${v.msnv}</p>
                    <p class="empBoxInfoRole">Chức vụ: Lao công</p>
                  </div>`;
                  doc.onclick = () => setJanitorEmail(v.email);
                });
              }
              loadAssignTask();
            </script>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="./js/index.js"></script>
    <script src="./js/view.js"></script>
  </body>
</html>
